# üéì Guide Complet - API REST avec RBAC (R√¥les)

## üìö Vue d'ensemble

Cette API impl√©mente un syst√®me de **contr√¥le d'acc√®s bas√© sur les r√¥les (RBAC)** avec 3 r√¥les :

### üîë Les 3 R√¥les

| R√¥le | Description | Permissions |
|------|-------------|-------------|
| **üë®‚Äçüíº Admin** | Administrateur syst√®me | - G√©rer tous les utilisateurs<br>- Acc√©der √† toutes les fonctionnalit√©s<br>- Modifier/supprimer tous les contenus |
| **üë®‚Äçüè´ Professeur** | Enseignant | - Cr√©er et g√©rer ses cours<br>- Voir les inscriptions de ses cours<br>- G√©rer ses notes personnelles |
| **üë®‚Äçüéì √âtudiant** | Apprenant | - S'inscrire aux cours<br>- Voir ses inscriptions<br>- G√©rer ses notes personnelles |

---

## üöÄ D√©marrage Rapide

### 1. Installation

```bash
# Installer les d√©pendances
npm install
cd functions && npm install && cd ..

# D√©marrer les √©mulateurs
npm run serve
```

### 2. Cr√©er le premier Admin (PowerShell)

```powershell
# 1. Cr√©er l'utilisateur dans Auth
$signup = Invoke-RestMethod -Method Post `
  -Uri "http://localhost:9099/identitytoolkit.googleapis.com/v1/accounts:signUp?key=anything" `
  -ContentType "application/json" `
  -Body '{"email":"admin@school.com","password":"admin123","returnSecureToken":true}'

$adminUid = $signup.localId

# 2. Se connecter pour obtenir le token
$login = Invoke-RestMethod -Method Post `
  -Uri "http://localhost:9099/identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key=anything" `
  -ContentType "application/json" `
  -Body '{"email":"admin@school.com","password":"admin123","returnSecureToken":true}'

$token = $login.idToken

# 3. Cr√©er le profil admin dans Firestore (via UI Emulator ou directement)
# Ouvrir http://localhost:4000 ‚Üí Firestore ‚Üí Collection "users" ‚Üí Ajouter document:
# Document ID: $adminUid (copier la valeur)
# Champs:
# - uid: $adminUid
# - email: "admin@school.com"
# - role: "admin"
# - firstName: "Super"
# - lastName: "Admin"
# - createdAt: 1704067200000
# - updatedAt: 1704067200000
```

**Alternative : Cr√©er le profil admin directement via l'API (n√©cessite de d√©sactiver temporairement le middleware requireAdmin)**

---

## üìñ Guide d'Utilisation par R√¥le

### üîê Variables d'environnement PowerShell

```powershell
# Base URL de l'API
$baseUrl = "http://localhost:5001/backend-demo-1/us-central1/api"

# Headers avec authentification
$headers = @{
    Authorization = "Bearer $token"
    "Content-Type" = "application/json"
}
```

---

## üë®‚Äçüíº Sc√©nario 1 : Admin

### Cr√©er un Professeur

```powershell
$prof = Invoke-RestMethod -Method Post `
  -Uri "$baseUrl/v1/users" `
  -Headers $headers `
  -Body (@{
    email = "prof.martin@school.com"
    password = "prof123"
    role = "professor"
    firstName = "Jean"
    lastName = "Martin"
  } | ConvertTo-Json)

$profUid = $prof.data.uid
Write-Host "Professeur cr√©√©: $profUid"
```

### Cr√©er des √âtudiants

```powershell
# √âtudiant 1
$student1 = Invoke-RestMethod -Method Post `
  -Uri "$baseUrl/v1/users" `
  -Headers $headers `
  -Body (@{
    email = "sophie.dubois@school.com"
    password = "student123"
    role = "student"
    firstName = "Sophie"
    lastName = "Dubois"
  } | ConvertTo-Json)

# √âtudiant 2
$student2 = Invoke-RestMethod -Method Post `
  -Uri "$baseUrl/v1/users" `
  -Headers $headers `
  -Body (@{
    email = "lucas.bernard@school.com"
    password = "student123"
    role = "student"
    firstName = "Lucas"
    lastName = "Bernard"
  } | ConvertTo-Json)

$student1Uid = $student1.data.uid
$student2Uid = $student2.data.uid
```

### Lister tous les utilisateurs

```powershell
# Tous les utilisateurs
Invoke-RestMethod -Uri "$baseUrl/v1/users" -Headers $headers

# Filtrer par r√¥le
Invoke-RestMethod -Uri "$baseUrl/v1/users?role=professor" -Headers $headers
Invoke-RestMethod -Uri "$baseUrl/v1/users?role=student" -Headers $headers
```

### Modifier le r√¥le d'un utilisateur

```powershell
Invoke-RestMethod -Method Put `
  -Uri "$baseUrl/v1/users/$student1Uid" `
  -Headers $headers `
  -Body (@{
    role = "professor"
  } | ConvertTo-Json)
```

### Supprimer un utilisateur

```powershell
Invoke-RestMethod -Method Delete `
  -Uri "$baseUrl/v1/users/$student2Uid" `
  -Headers $headers
```

---

## üë®‚Äçüè´ Sc√©nario 2 : Professeur

### Se connecter en tant que Professeur

```powershell
$profLogin = Invoke-RestMethod -Method Post `
  -Uri "http://localhost:9099/identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key=anything" `
  -ContentType "application/json" `
  -Body '{"email":"prof.martin@school.com","password":"prof123","returnSecureToken":true}'

$profToken = $profLogin.idToken

$profHeaders = @{
    Authorization = "Bearer $profToken"
    "Content-Type" = "application/json"
}
```

### Consulter son profil

```powershell
Invoke-RestMethod -Uri "$baseUrl/v1/profile" -Headers $profHeaders
```

### Cr√©er un cours

```powershell
$course1 = Invoke-RestMethod -Method Post `
  -Uri "$baseUrl/v1/courses" `
  -Headers $profHeaders `
  -Body (@{
    title = "Introduction √† Python"
    description = "Apprendre les bases de la programmation Python"
    maxStudents = 30
  } | ConvertTo-Json)

$courseId = $course1.data.id

$course2 = Invoke-RestMethod -Method Post `
  -Uri "$baseUrl/v1/courses" `
  -Headers $profHeaders `
  -Body (@{
    title = "JavaScript Avanc√©"
    description = "Concepts avanc√©s de JavaScript ES6+"
    maxStudents = 25
  } | ConvertTo-Json)
```

### Lister ses cours

```powershell
Invoke-RestMethod -Uri "$baseUrl/v1/courses/my" -Headers $profHeaders
```

### Modifier un cours

```powershell
Invoke-RestMethod -Method Put `
  -Uri "$baseUrl/v1/courses/$courseId" `
  -Headers $profHeaders `
  -Body (@{
    title = "Python pour D√©butants"
    maxStudents = 35
  } | ConvertTo-Json)
```

### Voir les inscriptions √† un cours

```powershell
Invoke-RestMethod `
  -Uri "$baseUrl/v1/courses/$courseId/enrollments" `
  -Headers $profHeaders
```

### Supprimer un cours

```powershell
Invoke-RestMethod -Method Delete `
  -Uri "$baseUrl/v1/courses/$courseId" `
  -Headers $profHeaders
```

---

## üë®‚Äçüéì Sc√©nario 3 : √âtudiant

### Se connecter en tant qu'√âtudiant

```powershell
$studentLogin = Invoke-RestMethod -Method Post `
  -Uri "http://localhost:9099/identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key=anything" `
  -ContentType "application/json" `
  -Body '{"email":"sophie.dubois@school.com","password":"student123","returnSecureToken":true}'

$studentToken = $studentLogin.idToken

$studentHeaders = @{
    Authorization = "Bearer $studentToken"
    "Content-Type" = "application/json"
}
```

### Consulter son profil

```powershell
Invoke-RestMethod -Uri "$baseUrl/v1/profile" -Headers $studentHeaders
```

### Modifier son profil

```powershell
Invoke-RestMethod -Method Put `
  -Uri "$baseUrl/v1/profile" `
  -Headers $studentHeaders `
  -Body (@{
    firstName = "Sophie"
    lastName = "Dubois-Martin"
  } | ConvertTo-Json)
```

### Lister tous les cours disponibles

```powershell
$courses = Invoke-RestMethod -Uri "$baseUrl/v1/courses" -Headers $studentHeaders
$courses.data | Format-Table id, title, professorName, currentStudents, maxStudents
```

### Consulter un cours sp√©cifique

```powershell
Invoke-RestMethod -Uri "$baseUrl/v1/courses/$courseId" -Headers $studentHeaders
```

### S'inscrire √† un cours

```powershell
$enrollment = Invoke-RestMethod -Method Post `
  -Uri "$baseUrl/v1/enrollments" `
  -Headers $studentHeaders `
  -Body (@{
    courseId = $courseId
  } | ConvertTo-Json)

$enrollmentId = $enrollment.data.id
```

### Voir ses inscriptions

```powershell
$myEnrollments = Invoke-RestMethod `
  -Uri "$baseUrl/v1/enrollments/my" `
  -Headers $studentHeaders

# Afficher avec d√©tails des cours
$myEnrollments.data | Format-Table studentName, status, @{Label="Course"; Expression={$_.course.title}}
```

### Annuler une inscription

```powershell
Invoke-RestMethod -Method Delete `
  -Uri "$baseUrl/v1/enrollments/$enrollmentId" `
  -Headers $studentHeaders
```

---

## üìù Gestion des Notes (Tous les r√¥les)

Tous les utilisateurs authentifi√©s peuvent g√©rer leurs propres notes.

### Cr√©er une note

```powershell
$note = Invoke-RestMethod -Method Post `
  -Uri "$baseUrl/v1/notes" `
  -Headers $studentHeaders `
  -Body (@{
    title = "R√©sum√© du cours Python"
    content = "Variables, fonctions, boucles..."
  } | ConvertTo-Json)

$noteId = $note.data.id
```

### Lister ses notes

```powershell
Invoke-RestMethod -Uri "$baseUrl/v1/notes" -Headers $studentHeaders
```

### Mettre √† jour une note

```powershell
Invoke-RestMethod -Method Put `
  -Uri "$baseUrl/v1/notes/$noteId" `
  -Headers $studentHeaders `
  -Body (@{
    title = "R√©sum√© Python - Chapitre 1"
    content = "Variables: int, str, float. Fonctions: def, return..."
  } | ConvertTo-Json)
```

### Supprimer une note

```powershell
Invoke-RestMethod -Method Delete `
  -Uri "$baseUrl/v1/notes/$noteId" `
  -Headers $studentHeaders
```

---

## üîí Tests de S√©curit√©

### Tester les permissions (doit √©chouer)

```powershell
# Un √©tudiant ne peut PAS cr√©er de cours
try {
    Invoke-RestMethod -Method Post `
      -Uri "$baseUrl/v1/courses" `
      -Headers $studentHeaders `
      -Body (@{
        title = "Cours non autoris√©"
        description = "Ceci devrait √©chouer"
        maxStudents = 10
      } | ConvertTo-Json)
} catch {
    Write-Host "‚ùå Erreur attendue: $($_.Exception.Response.StatusCode)"
}

# Un professeur ne peut PAS cr√©er d'utilisateurs
try {
    Invoke-RestMethod -Method Post `
      -Uri "$baseUrl/v1/users" `
      -Headers $profHeaders `
      -Body (@{
        email = "test@test.com"
        password = "test123"
        role = "student"
        firstName = "Test"
        lastName = "Test"
      } | ConvertTo-Json)
} catch {
    Write-Host "‚ùå Erreur attendue: $($_.Exception.Response.StatusCode)"
}
```

---

## üìä Tableau R√©capitulatif des Permissions

| Action | Admin | Professeur | √âtudiant |
|--------|-------|------------|----------|
| **Users** |
| Cr√©er utilisateurs | ‚úÖ | ‚ùå | ‚ùå |
| Lister utilisateurs | ‚úÖ | ‚ùå | ‚ùå |
| Modifier utilisateurs | ‚úÖ | ‚ùå | ‚ùå |
| Supprimer utilisateurs | ‚úÖ | ‚ùå | ‚ùå |
| **Courses** |
| Cr√©er cours | ‚úÖ | ‚úÖ | ‚ùå |
| Lister cours | ‚úÖ | ‚úÖ | ‚úÖ |
| Modifier ses cours | ‚úÖ | ‚úÖ | ‚ùå |
| Supprimer ses cours | ‚úÖ | ‚úÖ | ‚ùå |
| Voir inscriptions | ‚úÖ | ‚úÖ (ses cours) | ‚ùå |
| **Enrollments** |
| S'inscrire | ‚úÖ | ‚ùå | ‚úÖ |
| Voir ses inscriptions | ‚úÖ | ‚ùå | ‚úÖ |
| Annuler inscription | ‚úÖ | ‚ùå | ‚úÖ |
| **Notes** |
| CRUD notes | ‚úÖ | ‚úÖ | ‚úÖ |
| **Profile** |
| Voir son profil | ‚úÖ | ‚úÖ | ‚úÖ |
| Modifier son profil | ‚úÖ | ‚úÖ | ‚úÖ |

---

## üéØ Sc√©nario Complet de Test

```powershell
# Script complet de d√©monstration
$baseUrl = "http://localhost:5001/backend-demo-1/us-central1/api"

Write-Host "üéØ D√©monstration compl√®te du syst√®me RBAC" -ForegroundColor Cyan

# 1. Admin cr√©e des utilisateurs
Write-Host "`nüë®‚Äçüíº Admin: Cr√©ation des utilisateurs..." -ForegroundColor Yellow
# ... (code de cr√©ation d'admin, professeur, √©tudiants)

# 2. Professeur cr√©e des cours
Write-Host "`nüë®‚Äçüè´ Professeur: Cr√©ation de cours..." -ForegroundColor Yellow
# ... (code de cr√©ation de cours)

# 3. √âtudiant s'inscrit aux cours
Write-Host "`nüë®‚Äçüéì √âtudiant: Inscription aux cours..." -ForegroundColor Yellow
# ... (code d'inscription)

# 4. Professeur consulte les inscriptions
Write-Host "`nüë®‚Äçüè´ Professeur: Consultation des inscriptions..." -ForegroundColor Yellow
# ... (code de consultation)

Write-Host "`n‚úÖ D√©monstration termin√©e!" -ForegroundColor Green
```

---

## üöÄ D√©ploiement en Production

```bash
# D√©ployer les functions et les r√®gles
npm run deploy:all

# Cr√©er le premier admin en production
firebase auth:export users.json --project backend-demo-1
# Puis utiliser la console Firebase pour ajouter le document user
```

---

## üõ†Ô∏è Troubleshooting

### Erreur 403 "Forbidden"
- V√©rifier que l'utilisateur a un profil dans Firestore (`/users/{uid}`)
- V√©rifier que le r√¥le est correct
- V√©rifier que le token est valide

### Erreur "User profile not found"
- Cr√©er le document dans Firestore: `users/{uid}` avec les champs requis

### Cours complet
- V√©rifier `currentStudents < maxStudents`

---

## üìö Ressources

- [Firebase Auth Emulator](https://firebase.google.com/docs/emulator-suite/connect_auth)
- [Firestore Security Rules](https://firebase.google.com/docs/firestore/security/rules-conditions)
- [Express.js](https://expressjs.com/)

---

**Bon d√©veloppement! üöÄ**

