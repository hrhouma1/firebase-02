import * as functions from "firebase-functions";
import express from "express";
import cors from "cors";
import swaggerUi from "swagger-ui-express";
import {requireAuth} from "./middlewares/auth";
import {requireAdmin, requireProfessor, requireStudent} from "./middlewares/roles";
import {UserRole} from "./types";
import {getSwaggerSpec} from "./swagger";

// Controllers
import {
  signup,
  signin,
} from "./controllers/authController";

import {
  createNote,
  getNotes,
  getNote,
  updateNote,
  deleteNote,
} from "./controllers/noteController";

import {
  createUser,
  getUsers,
  getUser,
  updateUser,
  deleteUser,
  getProfile,
  updateProfile,
} from "./controllers/userController";

import {
  createCourse,
  getCourses,
  getCourse,
  updateCourse,
  deleteCourse,
  getMyCourses,
} from "./controllers/courseController";

import {
  enrollInCourse,
  getMyEnrollments,
  getCourseEnrollments,
  cancelEnrollment,
} from "./controllers/enrollmentController";

const app = express();
app.use(cors());
app.use(express.json());

// ==================== ROOT ROUTE ====================
// Preserve the Cloud Functions base path by using a relative redirect
app.get("/", (_req, res) => {
  res.redirect("docs/");
});

// ==================== SWAGGER DOCUMENTATION ====================
/**
 * @swagger
 * /docs:
 *   get:
 *     summary: Documentation Swagger UI
 *     description: Interface interactive pour tester l'API
 */

// Expose le sch√©ma OpenAPI √† c√¥t√© de Swagger (URL relative)
app.get("/docs/openapi.json", (_req, res) => {
  res.setHeader("Content-Type", "application/json");
  res.json(getSwaggerSpec());
});

// Monte Swagger UI sous un Router Express (SOLUTION FIREBASE FUNCTIONS)
const docsRouter = express.Router();
docsRouter.use("/", swaggerUi.serve);
docsRouter.get(
  "/",
  swaggerUi.setup(undefined, {
    customSiteTitle: "API Gestion Acad√©mique",
    customCss: ".swagger-ui .topbar { display: none }",
    swaggerOptions: {
      url: "./openapi.json", // URL RELATIVE - garde le pr√©fixe Firebase Functions
      deepLinking: true,
      validatorUrl: null,
    },
  })
);

// Monte le router sous /docs
app.use("/docs", docsRouter);

// ==================== AUTH ROUTES (Public) ====================
/**
 * @swagger
 * /v1/auth/signup:
 *   post:
 *     tags:
 *       - Auth
 *     summary: Cr√©er un compte utilisateur (Public)
 *     description: |
 *       Cr√©er un nouveau compte avec Auth + profil Firestore en une seule requ√™te.
 *       
 *       **Parfait pour les tests depuis Swagger !**
 *       
 *       Le compte est cr√©√© dans Firebase Auth ET le profil dans Firestore automatiquement.
 *     security: []
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - email
 *               - password
 *               - role
 *               - firstName
 *               - lastName
 *             properties:
 *               email:
 *                 type: string
 *                 format: email
 *                 example: admin@school.com
 *               password:
 *                 type: string
 *                 minLength: 6
 *                 example: admin123
 *               role:
 *                 type: string
 *                 enum: [admin, professor, student]
 *                 example: admin
 *               firstName:
 *                 type: string
 *                 example: Super
 *               lastName:
 *                 type: string
 *                 example: Admin
 *     responses:
 *       201:
 *         description: Compte cr√©√© avec succ√®s
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 data:
 *                   $ref: '#/components/schemas/User'
 *                 message:
 *                   type: string
 *                   example: Account created successfully. You can now login.
 *       400:
 *         description: Email d√©j√† utilis√© ou donn√©es invalides
 *       422:
 *         description: Donn√©es manquantes ou invalides
 *
 * /v1/auth/signin-info:
 *   post:
 *     tags:
 *       - Auth
 *     summary: Obtenir les instructions de connexion
 *     description: |
 *       Cette route retourne les instructions pour se connecter et obtenir un token.
 *       
 *       **Utilisez les instructions PowerShell fournies dans la r√©ponse.**
 *     security: []
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - email
 *               - password
 *             properties:
 *               email:
 *                 type: string
 *                 example: admin@school.com
 *               password:
 *                 type: string
 *                 example: admin123
 *     responses:
 *       200:
 *         description: Instructions de connexion
 */
app.post("/v1/auth/signup", signup);
app.post("/v1/auth/signin-info", signin);

// ==================== PUBLIC ROUTES ====================
/**
 * @swagger
 * /health:
 *   get:
 *     tags:
 *       - Health
 *     summary: Health check
 *     description: V√©rifier que l'API fonctionne
 *     security: []
 *     responses:
 *       200:
 *         description: API op√©rationnelle
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 ok:
 *                   type: boolean
 *                   example: true
 *                 service:
 *                   type: string
 *                   example: api
 *                 version:
 *                   type: string
 *                   example: v2
 *                 roles:
 *                   type: array
 *                   items:
 *                     type: string
 *                   example: ["admin", "professor", "student"]
 */
app.get("/health", (_req, res) => {
  res.status(200).json({
    ok: true,
    service: "api",
    version: "v2",
    roles: Object.values(UserRole),
    swagger: "/docs",
  });
});

// ==================== PROFILE ROUTES (Authenticated) ====================
/**
 * @swagger
 * /v1/profile:
 *   get:
 *     tags:
 *       - üë§ Profile
 *     summary: Consulter son profil
 *     description: R√©cup√©rer les informations de son profil utilisateur
 *     responses:
 *       200:
 *         description: Profil r√©cup√©r√©
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 data:
 *                   $ref: '#/components/schemas/User'
 *       401:
 *         description: Non authentifi√©
 *       404:
 *         description: Profil non trouv√©
 *   put:
 *     tags:
 *       - üë§ Profile
 *     summary: Modifier son profil
 *     description: Mettre √† jour son pr√©nom et nom (le r√¥le ne peut pas √™tre modifi√©)
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             properties:
 *               firstName:
 *                 type: string
 *                 example: Sophie
 *               lastName:
 *                 type: string
 *                 example: Dubois
 *     responses:
 *       200:
 *         description: Profil mis √† jour
 *       401:
 *         description: Non authentifi√©
 */
app.get("/v1/profile", requireAuth, getProfile);
app.put("/v1/profile", requireAuth, updateProfile);

// ==================== ADMIN ROUTES ====================
/**
 * @swagger
 * /v1/users:
 *   post:
 *     tags:
 *       - üë®‚Äçüíº Admin
 *     summary: Cr√©er un utilisateur (Admin uniquement)
 *     description: Cr√©er un nouvel utilisateur avec un r√¥le sp√©cifique
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - email
 *               - password
 *               - role
 *               - firstName
 *               - lastName
 *             properties:
 *               email:
 *                 type: string
 *                 format: email
 *                 example: prof.martin@school.com
 *               password:
 *                 type: string
 *                 example: prof123
 *               role:
 *                 type: string
 *                 enum: [admin, professor, student]
 *                 example: professor
 *               firstName:
 *                 type: string
 *                 example: Jean
 *               lastName:
 *                 type: string
 *                 example: Martin
 *     responses:
 *       201:
 *         description: Utilisateur cr√©√©
 *       403:
 *         description: Permissions insuffisantes
 *       422:
 *         description: Donn√©es invalides
 *   get:
 *     tags:
 *       - üë®‚Äçüíº Admin
 *     summary: Lister les utilisateurs (Admin uniquement)
 *     description: R√©cup√©rer tous les utilisateurs, filtrable par r√¥le
 *     parameters:
 *       - in: query
 *         name: role
 *         schema:
 *           type: string
 *           enum: [admin, professor, student]
 *         description: Filtrer par r√¥le
 *     responses:
 *       200:
 *         description: Liste des utilisateurs
 *       403:
 *         description: Permissions insuffisantes
 */
app.post("/v1/users", requireAuth, requireAdmin, createUser);
app.get("/v1/users", requireAuth, requireAdmin, getUsers);

/**
 * @swagger
 * /v1/users/{uid}:
 *   get:
 *     tags:
 *       - üë®‚Äçüíº Admin
 *     summary: Consulter un utilisateur (Admin uniquement)
 *     parameters:
 *       - in: path
 *         name: uid
 *         required: true
 *         schema:
 *           type: string
 *     responses:
 *       200:
 *         description: Utilisateur trouv√©
 *       404:
 *         description: Utilisateur non trouv√©
 *   put:
 *     tags:
 *       - üë®‚Äçüíº Admin
 *     summary: Modifier un utilisateur (Admin uniquement)
 *     parameters:
 *       - in: path
 *         name: uid
 *         required: true
 *         schema:
 *           type: string
 *     requestBody:
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             properties:
 *               role:
 *                 type: string
 *                 enum: [admin, professor, student]
 *               firstName:
 *                 type: string
 *               lastName:
 *                 type: string
 *     responses:
 *       200:
 *         description: Utilisateur mis √† jour
 *   delete:
 *     tags:
 *       - üë®‚Äçüíº Admin
 *     summary: Supprimer un utilisateur (Admin uniquement)
 *     parameters:
 *       - in: path
 *         name: uid
 *         required: true
 *         schema:
 *           type: string
 *     responses:
 *       200:
 *         description: Utilisateur supprim√©
 */
app.get("/v1/users/:uid", requireAuth, requireAdmin, getUser);
app.put("/v1/users/:uid", requireAuth, requireAdmin, updateUser);
app.delete("/v1/users/:uid", requireAuth, requireAdmin, deleteUser);

// ==================== PROFESSOR ROUTES ====================
/**
 * @swagger
 * /v1/courses/my:
 *   get:
 *     tags:
 *       - üë®‚Äçüè´ Courses
 *     summary: Lister MES cours (Professeur)
 *     description: R√©cup√©rer les cours cr√©√©s par le professeur connect√©
 *     responses:
 *       200:
 *         description: Liste des cours du professeur
 *       403:
 *         description: Permissions insuffisantes (r√¥le professeur requis)
 *
 * /v1/courses/{courseId}/enrollments:
 *   get:
 *     tags:
 *       - üë®‚Äçüè´ Courses
 *     summary: Voir les inscriptions d'un cours (Professeur)
 *     parameters:
 *       - in: path
 *         name: courseId
 *         required: true
 *         schema:
 *           type: string
 *     responses:
 *       200:
 *         description: Liste des inscriptions
 *       403:
 *         description: Permissions insuffisantes
 */
app.get("/v1/courses/my", requireAuth, requireProfessor, getMyCourses);
app.get(
  "/v1/courses/:courseId/enrollments",
  requireAuth,
  requireProfessor,
  getCourseEnrollments
);

// ==================== STUDENT ROUTES ====================
/**
 * @swagger
 * /v1/enrollments:
 *   post:
 *     tags:
 *       - üë®‚Äçüéì Enrollments
 *     summary: S'inscrire √† un cours (√âtudiant)
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - courseId
 *             properties:
 *               courseId:
 *                 type: string
 *                 example: course123
 *     responses:
 *       201:
 *         description: Inscription r√©ussie
 *       400:
 *         description: Cours complet ou d√©j√† inscrit
 *       403:
 *         description: R√¥le √©tudiant requis
 *
 * /v1/enrollments/my:
 *   get:
 *     tags:
 *       - üë®‚Äçüéì Enrollments
 *     summary: Voir MES inscriptions (√âtudiant)
 *     responses:
 *       200:
 *         description: Liste des inscriptions de l'√©tudiant
 *
 * /v1/enrollments/{id}:
 *   delete:
 *     tags:
 *       - üë®‚Äçüéì Enrollments
 *     summary: Annuler une inscription (√âtudiant)
 *     parameters:
 *       - in: path
 *         name: id
 *         required: true
 *         schema:
 *           type: string
 *     responses:
 *       200:
 *         description: Inscription annul√©e
 *       403:
 *         description: Vous pouvez seulement annuler vos propres inscriptions
 */
app.post("/v1/enrollments", requireAuth, requireStudent, enrollInCourse);
app.get("/v1/enrollments/my", requireAuth, requireStudent, getMyEnrollments);
app.delete("/v1/enrollments/:id", requireAuth, requireStudent, cancelEnrollment);

// ==================== ALL AUTHENTICATED ROUTES ====================
/**
 * @swagger
 * /v1/courses:
 *   get:
 *     tags:
 *       - üë®‚Äçüè´ Courses
 *     summary: Lister tous les cours disponibles
 *     description: Accessible √† tous les utilisateurs authentifi√©s
 *     responses:
 *       200:
 *         description: Liste de tous les cours
 *   post:
 *     tags:
 *       - üë®‚Äçüè´ Courses
 *     summary: Cr√©er un cours (Professeur)
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - title
 *               - description
 *               - maxStudents
 *             properties:
 *               title:
 *                 type: string
 *                 example: Introduction √† Python
 *               description:
 *                 type: string
 *                 example: Apprendre les bases de Python
 *               maxStudents:
 *                 type: integer
 *                 example: 30
 *     responses:
 *       201:
 *         description: Cours cr√©√©
 *       403:
 *         description: R√¥le professeur requis
 *
 * /v1/courses/{id}:
 *   get:
 *     tags:
 *       - üë®‚Äçüè´ Courses
 *     summary: Consulter un cours
 *     parameters:
 *       - in: path
 *         name: id
 *         required: true
 *         schema:
 *           type: string
 *     responses:
 *       200:
 *         description: D√©tails du cours
 *       404:
 *         description: Cours non trouv√©
 *   put:
 *     tags:
 *       - üë®‚Äçüè´ Courses
 *     summary: Modifier un cours (Professeur propri√©taire)
 *     parameters:
 *       - in: path
 *         name: id
 *         required: true
 *         schema:
 *           type: string
 *     requestBody:
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             properties:
 *               title:
 *                 type: string
 *               description:
 *                 type: string
 *               maxStudents:
 *                 type: integer
 *     responses:
 *       200:
 *         description: Cours mis √† jour
 *       403:
 *         description: Seul le professeur propri√©taire peut modifier
 *   delete:
 *     tags:
 *       - üë®‚Äçüè´ Courses
 *     summary: Supprimer un cours (Professeur propri√©taire)
 *     parameters:
 *       - in: path
 *         name: id
 *         required: true
 *         schema:
 *           type: string
 *     responses:
 *       200:
 *         description: Cours supprim√©
 *       403:
 *         description: Seul le professeur propri√©taire peut supprimer
 *
 * /v1/notes:
 *   get:
 *     tags:
 *       - üìù Notes
 *     summary: Lister MES notes
 *     responses:
 *       200:
 *         description: Liste de vos notes personnelles
 *   post:
 *     tags:
 *       - üìù Notes
 *     summary: Cr√©er une note
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - title
 *             properties:
 *               title:
 *                 type: string
 *                 example: R√©sum√© Python
 *               content:
 *                 type: string
 *                 example: Variables, fonctions, boucles...
 *     responses:
 *       201:
 *         description: Note cr√©√©e
 *
 * /v1/notes/{id}:
 *   get:
 *     tags:
 *       - üìù Notes
 *     summary: Consulter une note
 *     parameters:
 *       - in: path
 *         name: id
 *         required: true
 *         schema:
 *           type: string
 *     responses:
 *       200:
 *         description: D√©tails de la note
 *       403:
 *         description: Vous ne pouvez voir que vos propres notes
 *   put:
 *     tags:
 *       - üìù Notes
 *     summary: Modifier une note
 *     parameters:
 *       - in: path
 *         name: id
 *         required: true
 *         schema:
 *           type: string
 *     requestBody:
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             properties:
 *               title:
 *                 type: string
 *               content:
 *                 type: string
 *     responses:
 *       200:
 *         description: Note mise √† jour
 *   delete:
 *     tags:
 *       - üìù Notes
 *     summary: Supprimer une note
 *     parameters:
 *       - in: path
 *         name: id
 *         required: true
 *         schema:
 *           type: string
 *     responses:
 *       200:
 *         description: Note supprim√©e
 */
app.get("/v1/courses", requireAuth, getCourses);
app.post("/v1/courses", requireAuth, requireProfessor, createCourse);
app.get("/v1/courses/:id", requireAuth, getCourse);
app.put("/v1/courses/:id", requireAuth, requireProfessor, updateCourse);
app.delete("/v1/courses/:id", requireAuth, requireProfessor, deleteCourse);

app.post("/v1/notes", requireAuth, createNote);
app.get("/v1/notes", requireAuth, getNotes);
app.get("/v1/notes/:id", requireAuth, getNote);
app.put("/v1/notes/:id", requireAuth, updateNote);
app.delete("/v1/notes/:id", requireAuth, deleteNote);

export const api = functions.https.onRequest(app);

